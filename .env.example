# Zapat Configuration
# Copy to .env and fill in values: cp .env.example .env

# ─── GitHub ───────────────────────────────────────────────────────────
# GitHub organization or user that owns the repositories Zapat monitors.
GITHUB_ORG=your-org

# GitHub Personal Access Token (required for cron/headless use).
# Create at: https://github.com/settings/tokens/new
# Scopes needed: repo, read:org
GH_TOKEN=ghp_YOUR_TOKEN_HERE

# ─── Slack Notifications ──────────────────────────────────────────────
# Webhook URL for pipeline notifications (daily digests, failure alerts).
# Create at: https://api.slack.com/apps → Incoming Webhooks
# Leave blank to disable Slack notifications.
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL

# ─── Claude / AI Model ───────────────────────────────────────────────
# Zapat uses a 3-tier model strategy to balance quality and cost:
#   Lead (CLAUDE_MODEL) > Sub-agents (CLAUDE_SUBAGENT_MODEL) > Utility (CLAUDE_UTILITY_MODEL)
#
# Model for team leads (orchestrators) — needs strongest reasoning.
# Options: claude-opus-4-6, claude-sonnet-4-6, claude-haiku-4-5-20251001
CLAUDE_MODEL=claude-opus-4-6

# Model for sub-agents (reviewers, analysts) — focused, narrow tasks.
# Used by team-based prompts when spawning Task sub-agents.
CLAUDE_SUBAGENT_MODEL=claude-sonnet-4-6

# Model for utility tasks (test runners, standups, planning) — simple tasks.
# Used by scheduled jobs and the test runner trigger.
CLAUDE_UTILITY_MODEL=claude-haiku-4-5-20251001

# ─── Automation Directory ─────────────────────────────────────────────
# Auto-detected from script location. Override only if your checkout
# lives somewhere unexpected.
# AUTOMATION_DIR=/home/you/zapat

# ─── Compliance Mode ─────────────────────────────────────────────────
# When true, enables extra compliance checks:
#   - Security scan prompts include domain-specific rules
#   - PR reviews check for regulatory violations
#   - Agents consult compliance persona before merging
# Set to true and provide a compliance agent in config/agents.conf
# for regulated industries (healthcare, finance, etc.).
ENABLE_COMPLIANCE_MODE=false

# ─── Timezone ─────────────────────────────────────────────────────────
# Timezone used for cron schedules, log timestamps, and digest timing.
# Uses IANA timezone names: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
TZ=America/New_York

# ─── Budget Caps (USD per invocation) ────────────────────────────────
# Budget caps for scheduled jobs (non-interactive, run via claude -p).
# These are hard-enforced: Claude Code stops when the cap is hit.
MAX_BUDGET_DAILY_STANDUP=5
MAX_BUDGET_WEEKLY_PLANNING=15
MAX_BUDGET_MONTHLY_STRATEGY=25
MAX_BUDGET_SECURITY_SCAN=15

# Note: Interactive agent sessions (implementation, triage, review, research,
# tests, rework) use agent teams in interactive mode, where Claude Code does
# not currently support budget caps. For these jobs, spending is controlled
# via the TIMEOUT_* settings below — the session is killed when time runs out.

# ─── @zapat Mentions ──────────────────────────────────────────────────
# Enable detection of @zapat mentions in issue/PR comments.
# When enabled, commenting "@zapat <instruction>" triggers the pipeline.
ZAPAT_MENTION_ENABLED=true

# GitHub login of the account running Zapat (prevents self-mention loops).
# Set this to your GitHub username or machine account login.
# ZAPAT_BOT_LOGIN=your-github-username

# ─── Auto-Triage ─────────────────────────────────────────────────────
# When enabled, Zapat automatically triages ALL new issues — no labels needed.
# New issues without any Zapat label are picked up, triaged by the agent team,
# and the triage agent decides whether to implement, research, or leave for humans.
# Issues with assignees or the "human-only" label are always skipped.
AUTO_TRIAGE_NEW_ISSUES=true

# ─── Polling ──────────────────────────────────────────────────────────
# How often the poller checks GitHub for new issues/PRs (minutes).
# GitHub allows 5,000 API requests/hour. Each poll cycle uses ~10-11 calls
# per repo (quiet) or ~15-20 (busy). At 2-min polling:
#   1-5 repos:  safe (< 30% of limit)
#   10 repos:   moderate (~ 50% of limit)
#   20+ repos:  consider increasing to 5 minutes
POLL_INTERVAL_MINUTES=2

# Max concurrent agent-work sessions (implementation + rework combined).
MAX_CONCURRENT_WORK=10

# Max concurrent triage/review sessions (issue triage + PR review combined).
# Falls back to MAX_CONCURRENT_WORK if not set.
MAX_CONCURRENT_TRIAGE=10

# Max trigger dispatches per poll cycle. Prevents a single cycle from
# flooding the system (e.g., first boot with many existing issues).
# Items beyond this limit are deferred to the next cycle.
MAX_DISPATCH_PER_CYCLE=20

# Warn when total eligible items in a single poll cycle exceed this threshold.
# Helps detect first-boot floods or label misconfiguration early.
BACKLOG_WARNING_THRESHOLD=30

# ─── Prompt Limits ───────────────────────────────────────────────────
# Maximum characters of PR diff injected into review/rework prompts.
# Diffs exceeding this limit are truncated with a message telling the
# agent how to fetch the full diff via `gh pr diff`.
# ~40,000 chars ≈ ~10,000 tokens. Increase for large PRs if needed.
MAX_DIFF_CHARS=40000

# ─── Timeouts (seconds) ──────────────────────────────────────────────
TIMEOUT_DAILY_STANDUP=600
TIMEOUT_WEEKLY_PLANNING=900
TIMEOUT_MONTHLY_STRATEGY=1200
TIMEOUT_PR_REVIEW=600
TIMEOUT_ISSUE_TRIAGE=600
TIMEOUT_IMPLEMENT=1800
TIMEOUT_TEST_PR=1200
TIMEOUT_WRITE_TESTS=1800
TIMEOUT_RESEARCH=1800

# ─── Pane Health ──────────────────────────────────────────────────────
# When true, the monitor loop auto-resolves known stuck prompts in tmux
# panes (rate limits → select alternate model, permission prompts → accept).
# Fatal errors are always notified but never auto-resolved.
AUTO_RESOLVE_PROMPTS=true

# Minutes to wait before retrying after an account-level rate limit
# (e.g., "out of extra usage"). The session is torn down and the item
# goes back to pending with this delay. Does not count as a failed attempt.
RATE_LIMIT_RETRY_MINUTES=60

# ─── tmux Session Timeouts ──────────────────────────────────────────
# Seconds to wait for Claude CLI prompts when launching sessions.
# These scale automatically when more than 5 tmux windows are active.
TMUX_PERMISSIONS_TIMEOUT=30
TMUX_READINESS_TIMEOUT=30

# ─── Auto-Rebase ─────────────────────────────────────────────────────
# When main changes, automatically rebase open Zapat PRs that are behind.
# Prevents stale PRs from silently diverging after parallel merges.
AUTO_REBASE_ENABLED=true

# ─── Auto-Merge ──────────────────────────────────────────────────────
# Whether to auto-merge agent PRs that pass all checks.
AUTO_MERGE_ENABLED=true

# Hours to wait after PR is approved before auto-merging.
# Gives humans a window to review before merge.
AUTO_MERGE_DELAY_HOURS=4

# Maximum risk level that can be auto-merged (low, medium, high).
# PRs above this risk level require manual merge.
AUTO_MERGE_MAX_RISK=medium

# ─── Visual Verification ──────────────────────────────────────────────
# When enabled, UI-eligible repos get screenshot-based visual regression
# checks between testing and review. Only fires when ALL three conditions
# are met: (1) feature enabled, (2) repo type is web/extension,
# (3) PR contains UI-relevant file changes.
VISUAL_VERIFY_ENABLED=false

# Timeout for visual verification session (seconds).
TIMEOUT_VISUAL_VERIFY=600

# Default pages to screenshot (comma-separated paths).
# Can be overridden per-repo via config/{project}/visual-{repo-slug}.conf
VISUAL_VERIFY_PAGES=/

# Viewport sizes for screenshots (comma-separated WIDTHxHEIGHT).
VISUAL_VERIFY_VIEWPORTS=1920x1080

# ─── CI Auto-Fix ──────────────────────────────────────────────────────
# When enabled, trivial CI failures (lint, type, format errors) are
# automatically fixed by a lightweight single-agent pass instead of
# triggering a full rework cycle. Substantive failures (test logic,
# build errors) still go through the normal rework path.
CI_AUTOFIX_ENABLED=false

# Max auto-fix attempts before escalating to full rework.
# Does NOT count toward rework_cycles budget.
MAX_CI_FIX_ATTEMPTS=2

# Comma-separated failure types to auto-fix.
# Options: lint, type, format
CI_AUTOFIX_TYPES=lint,type,format

# ─── Human Handoff ────────────────────────────────────────────────────
# When the pipeline escalates to a human (max rework, rebase conflicts,
# high risk PRs), it posts a structured context comment on the PR.

# Generate Claude Code Desktop deep links in handoff comments.
# Lets humans click to open the PR context directly in Claude Code.
HANDOFF_DEEP_LINK_ENABLED=false

# Include session log excerpts in handoff comments.
# Helps humans understand what the agent tried.
HANDOFF_INCLUDE_LOGS=true

# Max number of log lines to include in handoff context.
HANDOFF_MAX_LOG_LINES=200

# ─── Dashboard ────────────────────────────────────────────────────────
# Host to bind the dashboard server to.
# Default: 127.0.0.1 (localhost only). Set to 0.0.0.0 for LAN access.
DASHBOARD_HOST=127.0.0.1

# Port for the Next.js dashboard (run with: bin/zapat dashboard).
DASHBOARD_PORT=8080

# Per-project dashboard ports (optional).
# When running: bin/zapat dashboard --serve --project <slug>
# the port is resolved as: DASHBOARD_PORT_<SLUG> → DASHBOARD_PORT → 3000
# Hyphens in slug are replaced with underscores for the env var name.
# DASHBOARD_PORT_ACME=8081
# DASHBOARD_PORT_MY_PROJECT=8082
